name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: 'Valid workflow'
            workflow_path: '.github/test-fixtures/valid-workflow.md'
            prompt: 'Test prompt'
            env_vars: '{"TEST_KEY": "test_value"}'
            should_fail: false

          - name: 'Missing workflow_path'
            workflow_path: ''
            prompt: ''
            env_vars: '{}'
            should_fail: true

          - name: 'Invalid env_vars JSON'
            workflow_path: '.github/test-fixtures/valid-workflow.md'
            prompt: ''
            env_vars: 'not-json'
            should_fail: true

          - name: 'Non-existent workflow'
            workflow_path: 'does/not/exist.md'
            prompt: ''
            env_vars: '{}'
            should_fail: true

          - name: 'Path traversal blocked'
            workflow_path: '../../../etc/passwd'
            prompt: ''
            env_vars: '{}'
            should_fail: true

          - name: 'Unicode workflow path'
            workflow_path: '.github/test-fixtures/workflow-日本語.md'
            prompt: 'Unicode prompt: 你好'
            env_vars: '{}'
            should_fail: false

          - name: 'Spaces in path'
            workflow_path: '.github/test-fixtures/workflow with spaces.md'
            prompt: ''
            env_vars: '{}'
            should_fail: false

          - name: 'Secret masking in logs'
            workflow_path: '.github/test-fixtures/valid-workflow.md'
            prompt: ''
            env_vars: '{"SECRET_VALUE": "super_secret_value_12345"}'
            should_fail: false
            verify_masked: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test fixtures
        run: |
          mkdir -p .github/test-fixtures
          echo "# Test Workflow" > ".github/test-fixtures/valid-workflow.md"
          echo "# Unicode Workflow" > ".github/test-fixtures/workflow-日本語.md"
          echo "# Spaces Workflow" > ".github/test-fixtures/workflow with spaces.md"

      - name: Run action - ${{ matrix.name }}
        id: test
        uses: ./
        continue-on-error: true
        with:
          workflow_path: ${{ matrix.workflow_path }}
          prompt: ${{ matrix.prompt }}
          env_vars: ${{ matrix.env_vars }}

      - name: Verify outcome - ${{ matrix.name }}
        run: |
          OUTCOME="${{ steps.test.outcome }}"
          SHOULD_FAIL="${{ matrix.should_fail }}"

          if [ "$SHOULD_FAIL" = "true" ]; then
            if [ "$OUTCOME" != "failure" ]; then
              echo "Expected failure but got: $OUTCOME"
              exit 1
            fi
            echo "Correctly failed as expected"
          else
            if [ "$OUTCOME" != "success" ]; then
              echo "Expected success but got: $OUTCOME"
              exit 1
            fi
            echo "Correctly succeeded as expected"
          fi

      - name: Verify outputs set
        if: steps.test.outcome == 'success'
        run: |
          STATUS="${{ steps.test.outputs.status }}"
          RESULT="${{ steps.test.outputs.result }}"

          if [ -z "$STATUS" ]; then
            echo "status output not set"
            exit 1
          fi

          if [ -z "$RESULT" ]; then
            echo "result output not set"
            exit 1
          fi

          echo "Status: $STATUS"
          echo "Result: $RESULT"

      - name: Verify secrets are masked
        if: matrix.verify_masked == true && steps.test.outcome == 'success'
        run: |
          RESULT="${{ steps.test.outputs.result }}"
          SECRET="super_secret_value_12345"

          if echo "$RESULT" | grep -q "$SECRET"; then
            echo "ERROR: Secret value found in plain text in output!"
            exit 1
          fi

          echo "Secret masking verified - value not exposed in output"
